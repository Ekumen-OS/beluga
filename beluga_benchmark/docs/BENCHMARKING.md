# How to benchmark Beluga

## Run rosbag benchmark parameterizing the number of particles

This script will run the benchmark with the specified number of particles and record:

- The `timem` output: CPU usage, RSS memory, virtual memory.
- A rosbag with the reference and estimated trajectories.
- Perf events (optionally).

To run, use:

```bash
ros2 run beluga_benchmark parameterized_run <NUMBER_OF_PARTICLES_EXPERIMENT_1> <NUMBER_OF_PARTICLES_EXPERIMENT_2> ... --initial-pose-y 2.0
```

Note that the initial pose value (x: 0, y: 2, theta: 0) is correct for the default rosbag. If not passed, particles will be initialized all around the map.
The results of the different runs will be stored in folders named `benchmark_${N_PARTICLES}_particles_output`, where `N_PARTICLES` are the numbers specified in the above command.

To run the same experiment using another AMCL node, e.g. nav2, use:

```bash
ros2 run beluga_benchmark parameterized_run <NUMBER_OF_PARTICLES_EXPERIMENT_1> <NUMBER_OF_PARTICLES_EXPERIMENT_2> ... --initial-pose-y 2.0 --package nav2_amcl --executable amcl
```

For other options, e.g. using a different rosbag, see:

```bash
ros2 run beluga_benchmark parameterized_run --help
```

## Visualizing timem results of one run

Use the following command:

```
ros2 run beluga_benchmark timem_results <PATH_TO_OUTPUT_DIR_OF_RUN>
```

Where the specified directory needs to have a `timem-output.json` file, e.g. the output directory generated by `parameterized_run`.
The script will print cpu usage, peak rss and elapsed time.
It will also plot virtual and RSS memory over time.

## Visualizing estimated trajectory APE of one run

Use the following command:

```
evo_ape bag2 <PATH_TO_BAGFILE> /odometry/ground_truth /pose -p
```

For `nav2_amcl`, replace `/pose` with `/amcl_pose`.
The bagfiles generated by `parameterized_run` can be found in the generated output directories for each run.
This will print APE metrics (mean, median, max, std, rmse, etc), and also plot APE over time.

## Comparing parameterized runs

This is useful to compare beluga vs another amcl node, e.g. `nav2_amcl`.
It's also useful to compare beluga using different settings.

```
ros2 run beluga_benchmark compare_results -b <BELUGA_RESULTS_PATH> -o <OTHER_RESULTS_PATH>
```

The results path should be the one where `parameterized_run` was run, i.e. the one containing the `benchmark_*_particles_output` directories.
The script will plot the following metrics vs the number of particles:

- RSS memory
- CPU usage
- APE mean
- APE median
- APE max
- APE rmse

## References

- https://github.com/NERSC/timemory
- https://github.com/MichaelGrupp/evo
